%---------------------------------------------------------------------------------------------------------------------------------------------------------
%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Outline}
\label{SUBSEC:Outline}
This analysis reconstructs the 4-momenta of the particles in the hard collision, using data from the generator level particles and reconstructed particles. Then several variables used in the analysis in Section.~\ref{SEC:ApplyingCuts} are evaluated and stored in a root file. In order to do this it must use some kinematically derived formulae (Section.~\ref{SUBSEC:ISRImplementation}) to reconstruct the 'invisible’ 4-momenta contribution of the neutrino and any initial state radiation (ISR). This section contains the details of each part of this analysis.

%---------------------------------------------------------------------------------------------------------------------------------------------------------%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Beam Background Removal}
\label{SUBSEC:BeamBackgroundRemoval}
In an $\eP\eM$ particle collider, to increase the probability of a hard collision, a 'bunch' \cite{bunch} of particles are 'collided’ and due to the low cross-section one may expect only one hard interaction to occur. These other particles, however, do interact with the detector and so will generate so-called beam background. This is modelled in the Monte Carlo simulation of the collision, and so must be removed before analysis of the hard collision can be conducted.
\\\\
The FastJetProcessor \cite{FastJet} was used to conduct such beam background removal from the reconstructed particle collection. Another method of background removal is by using generator level information to help remove the background from the reconstructed particles\footnote{A different steering file was used for this set up, further discussed in Section.~\ref{SUBSEC:SteeringFile}}, this was done with the TrueJet processor \cite{TrueJet}. This is of course a liberty that is only possible because the collisions are simulated, therefore it is not possible at an active detector and is referred to in this report as 'cheating overlay removal'. The later method was used to explore the sensitivity of the reconstruction to this beam background removal in Section.~\ref{SUBSUBSEC:BeamBackground}.

%---------------------------------------------------------------------------------------------------------------------------------------------------------%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{4-momenta Reconstruction}
\label{SUBSEC:4momentaReconstruction}
For the generator level particles, each of the particles in the hard collision were directly extracted from the collection using their element number. Elements 4 and 5 were the ISR photons, 6 and 7 the quarks, 8 the lepton and 9 the neutrino. It was then a simple task of inputting their energies and momenta into a TLorentzVector \cite{TLorentzVector}. The W bosons 4-momenta were then calculated by addition of the 4-momenta of its decay products.
\\\\
Extraction of the 4-momenta of the particles in the hard collision from the Reconstructed particles was done by looping through the particles in the various collections, extracting their momentum and energy, and summing them. The IsolatedLeptonTaggingProcessor \cite{IsolatedLeptonTaggingProcessor} returns the hard collision lepton\footnote{If it correctly reconstructs the lepton, sometimes it returned zero particles, sometimes more than one, this was cut on later}, and so summation over this collection reconstructed the 4-momenta of the lepton. The FastJetProcessor returns a colleciton containing the 2 reconstructed quarks, their 4-momenta and subsequently that of the hadronically decaying W boson (${W}_{had}$) could then be similarly reconstructed.
\\\\
***LEP or HAD?? At this point I will mention that re-vertexing did make a difference to the performance of this**********
\\\\
Reconstruction of the leptonically decaying W boson (${W}_{lep}$) required a bit more thought, this is because of the neutrino and the ISR photons which leave no signal in the detector. This challenge is discussed in detail in the following section.

%---------------------------------------------------------------------------------------------------------------------------------------------------------%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Neutrino and ISR Corrections: Implementation}
\label{SUBSEC:ISRImplementation}
The leptonically decaying W boson was reconstructed by summing the 4-momenta of the extracted lepton and the neutrino, however, the neutrino does not leave a signal in the detector. There is also some initial state radiation of photons (ISR) which are aligned enough to the beam pipe that they are also not detected. This results in an 'invisible' system that is not at all detected by the detector, and, to obtain complete information about the W bosons, this invisible system had to be reconstructed.
\\\\
The chosen method for reconstruction of the invisible system arises purely from conservation laws\footnote{ a full mathematical derivation is included in the appendix for completeness (Appendix.~\ref{App:Derivation})}. The reconstructed visible system was considered as being the hadronically decaying W boson plus the isolated lepton (${p}^{\mu} = ( E,  {p}_{x}, {p}_{y}, {p}_{z})$), and the invisible system as the accompanying neutrino and an ISR photon, travelling parallel to the beam. The total center of mass energy was assumed to be 500 GeV and the hard interation was assumed to take place in the center of mass frame. Conservation of momentum and energy then exactly defines the 4-momenta of the ISR photon and the neutrino. In the particle generation simulation there are actually two ISR photons emitted, this means that when combining the two photons into one 'photon', this 'photon' may have a non zero invariant mass. As well as this, the ISR photon could be going in either direction with respect to the beam axis, resulting in two solutions.
\begin{align}
\label{EQ:Full}
{E}_{\gamma}    &= \frac{{\lambda}(500 - E)  \pm {p}_{z}\sqrt{ {\lambda}^{2} - [{(500 - E)}^{2} -{p}_{z}^{2}]{m}_{\gamma}^{2}}}{{(500 - E)}^{2} -   {p}_{z}^{2}}
   \end{align}

where $ {\lambda} = \frac{1}{2}[{(500 - E)}^2 - {p}^{2} + {m}_{\gamma}^{2} - {m}_{\nu}^{2}] $ has been defined for convenience and no absolute values have been assumed.
\\\\
The solution that gives a better estimate for the invariant mass of the W boson is selected.  As described in Ivan's thesis \cite{IvanMarchesini} this may shift more of the background into the peak introducing a bias and so the appropriate cut was made to mitigate this.
\\\\
The rest of the unknown variables of momentum and energy are exactly defined from this and can be easily evaluated. As a result the 4-momenta of all of the particles in the hard interaction are known, as required for the analysis.
\\\\
A simplified form of this equation with ${m}_{\gamma}= \pm {m}_{\nu} = 0$ is used in Ivan's thesis. Equation.~(\ref{EQ:Full}) correctly simplifies to this solution as shown in the appendix.
 \begin{equation}
     \label{EQ:Simple}
  {E}_{\gamma} = \frac{ {(500 - E)}^2 - {p}^{2}}{1000 -2 E  \mp 2{p}_{z}}
\end{equation}
\\\\
 It is worth noting at this point that it is numerically possible for the particle reconstruction to result in a visible 4-momenta with a negative $\lambda$. It can be seen in the ${m}_{\gamma} = {m}_{\nu} =0$ solution that this corresponds to the invisible part of the system having an imaginary invariant mass.
\\
 \begin{align}
     \label{EQ:invariantMassNegative}
     {\lambda}_{{m}_{\gamma}, {m}_{\nu} = 0} \propto {(500 - E)}^2 - {p}^{2} &= {E}_{inv}^2 - {p}_{inv}^{2} = {m}_{inv}^2
 \end{align}
\\
When the analysis was first conducted this occurred in about 22\% of the events. This is obviously not physical and will affect the solutions attained above. For example as ${p}_{\gamma}= \pm {E}_{\gamma}$, a negative energy will reverse the direction of the photon. This needs to be handled carefully in the code to avoid inconsistent solutions and was a bug that resulted in a lot of the further analysis in Section.~\ref{SUBSEC:ISREvaluation}
\\\\
It can be analytically shown that Equation.~\ref{EQ:Full} leads to Equation.~\ref{EQ:Simple} when simplified, there is however one subtlety when this is done computationally. The $\sqrt{ {\lambda}^{2}}$ will computationally evaluate as $|{\lambda}|$, so if $\lambda$ is negative it will in effect reverse the effect of the $\pm$ in Equation.~\ref{EQ:Full} and lead to the opposite solution of the simplified form. So it is clear that these negative $\lambda$'s may cause some issues if the contribution from the ${m}_{\gamma}$ in non-negligible. This was not explored further, because in Section.~\ref{SUBSUBSEC:ISRInvarientMass} it is shown that including the non-zero ${m}_{\gamma}$ contribution from the Monte Carlo has little effect on the solutions attained and so Equation.~\ref{EQ:Simple} is used with the $\pm$ swapped accordingly.

%---------------------------------------------------------------------------------------------------------------------------------------------------------%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Neutrino and ISR Corrections: Evaluation}
\label{SUBSEC:ISREvaluation}
Using the method in Section.~\ref{SUBSEC:ISRImplementation} the 4-momentum of the leptonically decaying W boson was reconstructed. As a test of the performance of this, the acuracy of the reconstructed invariant mass of this boson was evaluated, this was also done the previous time this analysis was performed in 2011 by Ivan.
\\\\
Due to the negative ISR photon energies described in the previous section, a bug in the code resulted in a very poorly defined mass peak. What was worse was that the analysis would return a significantly better peak, at around 80 GeV which is close to the currently accepted measurement of 80.3 GeV \cite{pdgLive}, if it considered the case where there is no ISR at all. Most of the following exploration was conducted to try and identify the cause of the problem. Now that the bug is fixed the results are of interest in testing the sensitivity of the formula to different parameters, these fixed results will be discuss now.

%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{Center of Mass frame}
\label{SUBSUBSEC:CenterOfMassFrame}
The assumption that the collision is occurring in the centre of mass frame is not trivially satisfied by just reading in the input collection. The $\eP\eM$ collision is incident at a non zero angle, consequently the total system has a non-zero 3-momentum $ {p}^{\mu} = ( 500 \sin{(\frac{0.014}{2})}, 0, 0 )$ GeV. This initially was not considered in the analysis because the x-momentum was considered negligible, but in theory addition of a boost into the centre of mass frame should result in an improvement in the reconstruction. In fact we see that is makes a considerable improvement to the mass peak as expected (Figure.~\ref{SUBFIG:Boost}) and was kept in the following analysis.

%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{ISR invarient mass}
\label{SUBSUBSEC:ISRInvarientMass}
Another assumption that was tested was the non-zero invariant mass of the ISR photon. A quick look at the MC collection revealed that the invariant mass was indeed non-zero for some of the events, the effect of this was investigated. The true invariant mass was obtained from the generator level particles, by summing the 4-momenta of the 2 extracted photons, and inputed into Equation.~\ref{EQ:Full}. Again this is a 'cheat' as this information would not be available in a real detector. As can be seen in Figure.~\ref{SUBFIG:MassFig}, this addition had a negligible effect on the reconstructed W mass. This could be due to the size of the photon mass indeed being negligible, even if non-zero.

\begin{figure}
  \centering
  \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=\textwidth]{\imagepath/Boost.pdf}
    \caption{}
    \label{SUBFIG:Boost}
  \end{subfigure}
  \begin{subfigure}[t]{0.45\textwidth}
    \centering
    \includegraphics[width=\textwidth]{\imagepath/Mass.pdf}
    \caption{}
    \label{SUBFIG:MassFig}
  \end{subfigure}
  \caption{
    Plots displaying the effect on the reconstructed invarient mass of the leptonically decaying W with different reconstruction methods.
    The simulated $\eP\eM$ collision is not head on, but with a finite momentum in the x direction, \subfigref{SUBFIG:Boost} shows the effect of boosting into the ZMF before applying the reconstruction method.
    \subfigref{SUBFIG:MassFig} shows the effect of inputting a non-zero invarient ISR photon mass into the reconstruction (extracted from the MC collection).
    }
  \label{FIG:BoostMass}
\end{figure}

%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{Beam Background}
\label{SUBSUBSEC:BeamBackground}
The third check that was performed was the sensitivity of the reconstructed ${m}_{W_{lep}}$  to the beam background. This was done by comparing the 2 different background removal methods suggested in Section.~\ref{SUBSEC:BeamBackgroundRemoval}. It was found that cheating the beam background removal improved the reconstruction of the 2 quarks, which can be seen in the reconstruction of the invariant mass of the hadronically decaying W boson (Figure.~\ref{FIG:Cheat}). In particular this cheating greatly supresses an overestimation tail observed in the properly reconstructed particles. This in turn improves the reconstruction of the visible portion of the system. The ${m}_{W_{lep}}$ on the other hand was generally unsensitive to this change. Explaining this is non-trivial due to the fairly complicated nature of the $E_{\gamma}$ formula.
\begin{figure}
    \begin{subfigure}[t]{0.45\textwidth}
      \centering
      \includegraphics[width=\textwidth]{\imagepath/Lep.pdf}
      \caption{}
      \label{SUBFIG:CheatLep}
    \end{subfigure}
    \begin{subfigure}[t]{0.45\textwidth}
      \centering
      \includegraphics[width=\textwidth]{\imagepath/Jet.pdf}
      \caption{}
      \label{SUBFIG:CheatHad}
    \end{subfigure}
    \caption{
        Plots displaying the effect of cheating the beam background removal on the reconstructed invarient mass of the two W bosons,
        \subfigref{SUBFIG:CheatLep} the leptonically decaying W and \subfigref{SUBFIG:CheatHad} decaying hadronically.
      }
    \label{FIG:Cheat}
\end{figure}

%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{No ISR}
\label{SUBSUBSEC:NoISR}
Another place where the formula seemed to be performing poorly was when the true ISR from MC had no or negligible energies. This is shown by Figure.~\ref{SUBFIG:ZeroPhoton}, where the peak is not centered on zero and some considerable overestimations are observed. Before the bug was fixed it also appeared like a solution with no ISR was performing better. Hence addition of a third solution to the photon energy formula was implemented, where the photon energy, and hence momentum, was set exactly equal to zero. The conservation laws then directly defined the 4-momenta of the neutrino, as it was then the only contribution to the invisible part of the system. As before the estimate of ${m}_{W_{lep}}$ was calculated using all 3 solutions to $E_{\gamma}$ and the solution that more accurately reconstructed this mass was chosen. Once again this selection may draw more of the background into the peak and introduce a bias. The extent of this is not explored in this report, but it is important to keep into consideration in the following, and any further, analysis. This seems to improve the estimation of ${m}_{W_{lep}}$ as seen in (Figure.~\ref{SUBFIG:Mass3}), although it is unclear if this is a true improvement in the method due this bias.
\begin{figure}
    \begin{subfigure}[t]{0.32\textwidth}
      \centering
      \includegraphics[width=\textwidth]{\imagepath/ZeroPhoton.pdf}
      \caption{}
      \label{SUBFIG:ZeroPhoton}
    \end{subfigure}
    \begin{subfigure}[t]{0.32\textwidth}
      \centering
      \includegraphics[width=\textwidth]{\imagepath/Mass3.pdf}
      \caption{}
      \label{SUBFIG:Mass3}
    \end{subfigure}
    \begin{subfigure}[t]{0.32\textwidth}
      \centering
      \includegraphics[width=\textwidth]{\imagepath/Photon_Ediff_log3.pdf}
      \caption{}
      \label{SUBFIG:Ediff}
    \end{subfigure}
    \caption{
    \subfigref{SUBFIG:ZeroPhoton} displays the reconstructed ISR photon energy from Equation.~\ref{EQ:Simple}, for cases when the MC ISR energy is zero.\\
    \subfigref{SUBFIG:Mass3} is a histogram showing how well the 3 different ${E}_{\gamma}$ claculation methods reconstruct the leptonically decaying W mass.\\
    \subfigref{SUBFIG:Ediff} is a log histogram plot showing how well the 3 different claculation methods reconstruct ${E}_{\gamma}$.
     }
    \label{FIG:ZeroPhoton}
\end{figure}
\\\\
As another check of the  performance of this edit, the difference between the reconstructed ISR photon energy and the MC ISR photon energy was plotted, to see if this improvement in ${m}_{W_{lep}}$ was accompanied by an improvement in the estimation of $E_{\gamma}$. A 'pull' histogram ($\frac{E_{\gamma}^{Reco} - E_{\gamma}^{MC}}{E_{\gamma}^{MC}}$) was created to analyse the performance but this returned a fairly large number of divide by zero errors. As the cases with  $E_{\gamma} = 0$ are the ones of interest, instead a histogram of just $E_{\gamma}^{Reco} - E_{\gamma}^{MC}$ was created (Figure.~\ref{SUBFIG:Ediff}). Here it can be seen that the addition of the $E_{\gamma} = 0$ solution  reduces the number of under and over estimates quite significantly. The highest peak at zero , however, claimed by the solution where there is no ISR considered at all (green). This means that sometimes an over/under-estimation of the photon energy returns a better reconstruction of the ${m}_{W_{lep}}$.

%---------------------------------------------------------------------------------------------------------------------------------------------------------%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Angle extractions}
\label{SUBSEC:AngleExtractions}
From this analysis, complete information about the final state particles, and hence the intermediate W pair, is obtained. From this we can evaluate the angular distributions required for the next section of the analysis.
\\\\
The semileptonic decay of a pair of W bosons is fully described by just 6 angles; the polar coordinates of the ${W}{-}$ in the center of mass frame; the polar coordinated of the lepton in the center of mass frame of the W it decayed from; and the polar coordinated of one of the quarks in the center of mass frame of the boson it decayed from. The $\phi$ coordinate of the ${W}{-}$ is expected to be uniformly distributed and so returns no information about the chiral structe and is not considered in the fit. Further, it is hard to assign a charge to the quarks in their reconstruction, so it is not possible to consistently chose one the the quarks to measure its angles. Hence the quarks polar coordinates are also not considered in this analysis. This leaves just 3 angles as defined in Figure.~\ref{FIG:Angles}, namely the theta coordinate of the ${W}^{-}$ in the centre of mass frame (${\theta}_{{W}^{-}}$), and the theta and phi coordinates of the lepton in the rest frame of the ${W}_{lep}$ it decayed from (${\theta}_{l}^{*}$ and ${\phi}_{l}^{*}$). The polar coordinate system is the same in both frames, with the z axis aligned to the beam-pipe. The same lorentz boost framework used in Section.~\ref{SUBSUBSEC:CenterOfMassFrame} was implemented here and so this was a computationally very simple task, and the extracted angles were put in the root tree.
\\\\
\begin{figure}
    \includegraphics[width=\textwidth]{\imagepath/AngleDiag.pdf}
    \caption{
    Angle definition for the 4-fermion final state from ${W}^{-}$ pair production in the semileptonic channel in which the W− decays leptonically. In the top part, the production angles ${\theta}_{{W}^{-}}$ and ${\theta}_{{W}^{+}}$ are defined by the axis of the initial colliding particles and the direction for the respective boson. The azimuthal angles ${\phi}_{{W}^{-}}$ and ${\phi}_{{W}^{+}}$ describe the rotation around the axis of the initial colliding particles.\\
    The bottom picture shows the angular definition of the decay products of the ${W}^{lep}$ boson in its rest frame. It shows the polar angles ${\theta}_{l}^{*}$ and ${\theta}_{\nubar}^{*}$ and the azimuth angles ${\phi}_{l}^{*}$ and ${\phi}_{\nubar}^{*}$ of the corresponding leptons. The ∗ denotes quantities in the rest frame of the ${W}^{lep}$ boson. (Edited from Robert Karl \cite{RobertKarl})
      }
    \label{FIG:Angles}
\end{figure}
The resulting angular distributions that were obtained are visible in Figure.~\ref{FIG:AngleEfficiencies}, where the $\theta$ angles have been displayed in terms of their cosine for comparison with Robert’s results \cite{RobertKarl}.

%---------------------------------------------------------------------------------------------------------------------------------------------------------%---------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Steering file}
\label{SUBSEC:SteeringFile}

In order for Marlin to run the analysis correctly, A 'steering file’ was created, which explicitly outlines what Marlin should run, in what order, and the parameters it should input/output at each step. This steering file runs the following processors in order,
\begin{itemize}
	\item IsolatedLeptonTaggingProcessor
	\item FastJetProcessor (Beam Background Removal)
	\item FastJetProcessor (Jet Clustering)
	\item MyFirstObservableProcessor
\end{itemize}
This registers the appropriate input collections for my processor, which generates and fills a root file.
\\\\
The only deviation from this format of steering file was when the beam background removal was cheated. Here the "FastJetProcessor (Beam Background Removal)" processor was replaced with a "TrueJet"\cite{TrueJet} processor followed by a "TJJetRecoParticleFinder"\cite{TJJetRecoParticleFinder} processor. A more detailed description of the inputs and outputs of these processors is given in the Appendix.~\ref{App:SteeringFile}
